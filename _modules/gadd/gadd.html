<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <!-- Generated with Sphinx 8.1.3 and Furo 2024.08.06 -->
        <title>gadd.gadd - GADD 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/qiskit-sphinx-theme.css?v=8ff9dcb6" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=302659d7" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style><link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=IBM+Plex+Sans:ital,wght@0,400;0,600;1,400;1,600&display=swap" rel="stylesheet"></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M14 2H2C1.73478 2 1.48043 2.10536 1.29289 2.29289C1.10536 2.48043 1 2.73478 1 3V13C1 13.2652 1.10536 13.5196 1.29289 13.7071C1.48043 13.8946 1.73478 14 2 14H14C14.2652 14 14.5196 13.8946 14.7071 13.7071C14.8946 13.5196 15 13.2652 15 13V3C15 2.73478 14.8946 2.48043 14.7071 2.29289C14.5196 2.10536 14.2652 2 14 2V2ZM2 3H10V13H2V3ZM14 13H11V3H14V13Z" fill="currentColor"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M14 3H2V4H14V3Z" fill="currentColor"/>
      <path d="M14 12H2V13H14V12Z" fill="currentColor"/>
      <path d="M14 6H2V7H14V6Z" fill="currentColor"/>
      <path d="M14 9H2V10H14V9Z" fill="currentColor"/>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M11 8L6.00005 13L5.30005 12.3L9.60005 8L5.30005 3.7L6.00005 3L11 8Z" fill="currentColor"/>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M15 13H1V14H15V13Z" fill="currentColor"/>
      <path d="M12.7 4.5C13.1 4.1 13.1 3.5 12.7 3.1L10.9 1.3C10.5 0.9 9.9 0.9 9.5 1.3L2 8.8V12H5.2L12.7 4.5ZM10.2 2L12 3.8L10.5 5.3L8.7 3.5L10.2 2ZM3 11V9.2L8 4.2L9.8 6L4.8 11H3Z" fill="currentColor"/>
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M11 13.0002C11.5523 13.0002 12 12.5525 12 12.0002C12 11.4479 11.5523 11.0002 11 11.0002C10.4477 11.0002 10 11.4479 10 12.0002C10 12.5525 10.4477 13.0002 11 13.0002Z" fill="currentColor"/>
      <path d="M14.8884 11.7394C14.5795 10.9524 14.0464 10.2734 13.3552 9.78646C12.664 9.29954 11.8451 9.02615 11 9.00017C10.1549 9.02615 9.33604 9.29954 8.64484 9.78646C7.95365 10.2734 7.42052 10.9524 7.11155 11.7394L7 12.0002L7.11155 12.2609C7.42052 13.0479 7.95365 13.727 8.64484 14.2139C9.33604 14.7008 10.1549 14.9742 11 15.0002C11.8451 14.9742 12.664 14.7008 13.3552 14.2139C14.0464 13.727 14.5795 13.0479 14.8884 12.2609L15 12.0002L14.8884 11.7394ZM11 14.0002C10.6044 14.0002 10.2178 13.8829 9.88886 13.6631C9.55996 13.4433 9.30362 13.131 9.15224 12.7655C9.00087 12.4001 8.96126 11.998 9.03843 11.61C9.1156 11.222 9.30608 10.8657 9.58579 10.586C9.86549 10.3063 10.2219 10.1158 10.6098 10.0386C10.9978 9.96143 11.3999 10.001 11.7654 10.1524C12.1308 10.3038 12.4432 10.5601 12.6629 10.889C12.8827 11.2179 13 11.6046 13 12.0002C12.9994 12.5304 12.7885 13.0388 12.4136 13.4137C12.0386 13.7887 11.5303 13.9996 11 14.0002Z" fill="currentColor"/>
      <path d="M6 14.0002H4V2.00017H8V5.00017C8.00077 5.26515 8.10637 5.51906 8.29374 5.70643C8.48111 5.8938 8.73502 5.99941 9 6.00017H12V8.00017H13V5.00017C13.0018 4.93446 12.9893 4.86913 12.9634 4.80871C12.9375 4.74828 12.8988 4.6942 12.85 4.65017L9.35 1.15017C9.30599 1.10134 9.2519 1.06263 9.19147 1.03674C9.13104 1.01084 9.06572 0.998364 9 1.00017H4C3.73502 1.00094 3.48111 1.10654 3.29374 1.29391C3.10637 1.48128 3.00077 1.73519 3 2.00017V14.0002C3.00077 14.2652 3.10637 14.5191 3.29374 14.7064C3.48111 14.8938 3.73502 14.9994 4 15.0002H6V14.0002ZM9 2.20017L11.8 5.00017H9V2.20017Z" fill="currentColor"/>
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">GADD 0.1.0 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">GADD 0.1.0 documentation</span>
  
</a>
<form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/gadd.html">GADD Core Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/strategies.html">DD Strategies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/utility_functions.html">Utility Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/group_operations.html">Group Operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/circuit_padding.html">Circuit Padding</a></li>
</ul>

</div></div>
      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for gadd.gadd</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Core GADD functionality.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">asdict</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">BitGenerator</span><span class="p">,</span> <span class="n">Generator</span><span class="p">,</span> <span class="n">SeedSequence</span><span class="p">,</span> <span class="n">default_rng</span>

<span class="kn">from</span> <span class="nn">qiskit</span> <span class="kn">import</span> <span class="n">QuantumCircuit</span>
<span class="kn">from</span> <span class="nn">qiskit.providers</span> <span class="kn">import</span> <span class="n">Backend</span>
<span class="kn">from</span> <span class="nn">qiskit.transpiler</span> <span class="kn">import</span> <span class="n">InstructionDurations</span>
<span class="kn">from</span> <span class="nn">qiskit_ibm_runtime</span> <span class="kn">import</span> <span class="n">Sampler</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">.strategies</span> <span class="kn">import</span> <span class="n">DDStrategy</span><span class="p">,</span> <span class="n">DDSequence</span><span class="p">,</span> <span class="n">StandardSequences</span><span class="p">,</span> <span class="n">ColorAssignment</span>
<span class="kn">from</span> <span class="nn">.group_operations</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">complete_sequence_to_identity</span><span class="p">,</span>
    <span class="n">DecouplingGroup</span><span class="p">,</span>
    <span class="n">DEFAULT_GROUP</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.circuit_padding</span> <span class="kn">import</span> <span class="n">apply_dd_strategy</span> <span class="k">as</span> <span class="n">_apply_dd_strategy</span>
<span class="kn">from</span> <span class="nn">.utility_functions</span> <span class="kn">import</span> <span class="n">UtilityFunction</span><span class="p">,</span> <span class="n">SuccessProbability</span>


<div class="viewcode-block" id="TrainingConfig">
<a class="viewcode-back" href="../../api/gadd.html#gadd.gadd.TrainingConfig">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">TrainingConfig</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration parameters for GADD training.</span>

<span class="sd">    Args:</span>
<span class="sd">        pop_size (int): Size of the population (``K`` in the paper).</span>
<span class="sd">        sequence_length (int): Length of each DD sequence (``L`` in the paper).</span>
<span class="sd">        parent_fraction (float): Fraction of population to use as parents for</span>
<span class="sd">            reproduction. Default is 0.25 from the paper.</span>
<span class="sd">        n_iterations (int): Number of GA iterations to run.</span>
<span class="sd">        mutation_probability (float): Initial probability of mutation.</span>
<span class="sd">        optimization_level (int): Qiskit transpilation optimization level.</span>
<span class="sd">        shots (int): Number of shots for quantum circuit execution.</span>
<span class="sd">        num_colors (int): Number of distinct sequences per strategy (``k`` in the</span>
<span class="sd">            paper).</span>
<span class="sd">        decoupling_group (DecouplingGroup): The decoupling group to use.</span>
<span class="sd">            Default is ``G`` from the paper.</span>
<span class="sd">        mode (str): Mode for generating initial population. Can be either ``uniform``</span>
<span class="sd">            or ``random``.</span>
<span class="sd">        dynamic_mutation (bool): Whether to dynamically adjust mutation probability.</span>
<span class="sd">        mutation_decay (float): Factor to adjust mutation probability.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pop_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="n">sequence_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">parent_fraction</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.25</span>
    <span class="n">n_iterations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">mutation_probability</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.75</span>
    <span class="n">optimization_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">shots</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4000</span>
    <span class="n">num_colors</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">decoupling_group</span><span class="p">:</span> <span class="n">DecouplingGroup</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">DEFAULT_GROUP</span><span class="p">)</span>
    <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;uniform&quot;</span>
    <span class="n">dynamic_mutation</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">mutation_decay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>

<div class="viewcode-block" id="TrainingConfig.to_dict">
<a class="viewcode-back" href="../../api/gadd.html#gadd.gadd.TrainingConfig.to_dict">[docs]</a>
    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Serializes training configuration to a dictionary.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Any]: The serialized output.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># Convert DecouplingGroup to dict for serialization</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;decoupling_group&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;elements&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoupling_group</span><span class="o">.</span><span class="n">elements</span><span class="p">,</span>
            <span class="s2">&quot;names&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoupling_group</span><span class="o">.</span><span class="n">names</span><span class="p">,</span>
            <span class="s2">&quot;multiplication&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoupling_group</span><span class="o">.</span><span class="n">multiplication</span><span class="p">,</span>
            <span class="s2">&quot;inverse_map&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoupling_group</span><span class="o">.</span><span class="n">inverse_map</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="TrainingConfig.from_dict">
<a class="viewcode-back" href="../../api/gadd.html#gadd.gadd.TrainingConfig.from_dict">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;TrainingConfig&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deserializes a dictionary object to a ``TrainingConfig`` object.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (Dict[str, Any]): The serialized input.</span>

<span class="sd">        Returns:</span>
<span class="sd">            TrainingConfig: The deserialized output.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convert decoupling_group dict back to DecouplingGroup</span>
        <span class="k">if</span> <span class="s2">&quot;decoupling_group&quot;</span> <span class="ow">in</span> <span class="n">data</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;decoupling_group&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">group_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;decoupling_group&quot;</span><span class="p">]</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;decoupling_group&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DecouplingGroup</span><span class="p">(</span><span class="o">**</span><span class="n">group_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span></div>


<div class="viewcode-block" id="TrainingConfig.__str__">
<a class="viewcode-back" href="../../api/gadd.html#gadd.gadd.TrainingConfig.__str__">[docs]</a>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return human-readable string representation.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;GADD Training Configuration:&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;  Population size: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pop_size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;  Sequence length: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sequence_length</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;  Iterations: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_iterations</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;  Colors: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_colors</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;  Shots per evaluation: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">shots</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;  Mutation probability: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mutation_probability</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;  Mode: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_mutation</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Dynamic mutation: enabled (decay=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mutation_decay</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TrainingState">
<a class="viewcode-back" href="../../api/gadd.html#gadd.gadd.TrainingState">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">TrainingState</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;State of GADD training that can be serialized and resumed.&quot;&quot;&quot;</span>

    <span class="n">population</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">best_scores</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">best_sequences</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">mutation_probability</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.75</span>
    <span class="n">iteration_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">())</span>

<div class="viewcode-block" id="TrainingState.to_dict">
<a class="viewcode-back" href="../../api/gadd.html#gadd.gadd.TrainingState.to_dict">[docs]</a>
    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="TrainingState.from_dict">
<a class="viewcode-back" href="../../api/gadd.html#gadd.gadd.TrainingState.from_dict">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s2">&quot;TrainingState&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="TrainingResult">
<a class="viewcode-back" href="../../api/gadd.html#gadd.gadd.TrainingResult">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">TrainingResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Results from GADD training.&quot;&quot;&quot;</span>

    <span class="n">best_sequence</span><span class="p">:</span> <span class="n">DDStrategy</span>
    <span class="n">best_score</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">iteration_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
    <span class="n">benchmark_scores</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
    <span class="n">final_population</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">TrainingConfig</span>
    <span class="n">training_time</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">benchmark_history</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="kc">None</span>  <span class="c1"># Only if tracked each iteration</span>
    <span class="p">)</span>

<div class="viewcode-block" id="TrainingResult.__post_init__">
<a class="viewcode-back" href="../../api/gadd.html#gadd.gadd.TrainingResult.__post_init__">[docs]</a>
    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract benchmark history from iteration data.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration_data</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">benchmark_history</span><span class="p">:</span>
            <span class="c1"># Extract benchmark scores from iteration data</span>
            <span class="n">benchmarks</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration_data</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;benchmark_scores&quot;</span> <span class="ow">in</span> <span class="n">iteration</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">iteration</span><span class="p">[</span><span class="s2">&quot;benchmark_scores&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">benchmarks</span><span class="p">:</span>
                            <span class="n">benchmarks</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">benchmarks</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">benchmark_history</span> <span class="o">=</span> <span class="n">benchmarks</span></div>


<div class="viewcode-block" id="TrainingResult.to_dict">
<a class="viewcode-back" href="../../api/gadd.html#gadd.gadd.TrainingResult.to_dict">[docs]</a>
    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">result_dict</span> <span class="o">=</span> <span class="n">asdict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">result_dict</span><span class="p">[</span><span class="s2">&quot;best_sequence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_sequence</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">result_dict</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result_dict</span></div>


<div class="viewcode-block" id="TrainingResult.__str__">
<a class="viewcode-back" href="../../api/gadd.html#gadd.gadd.TrainingResult.__str__">[docs]</a>
    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return human-readable string representation.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;GADD Training Results:&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;  Best score: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">best_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;  Training time: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">training_time</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;  Iterations completed: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration_data</span><span class="p">:</span>
            <span class="n">first_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;best_score&quot;</span><span class="p">]</span>
            <span class="n">improvement</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_score</span> <span class="o">-</span> <span class="n">first_score</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Score improvement: +</span><span class="si">{</span><span class="n">improvement</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comparison_data</span><span class="p">:</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;  Compared against </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comparison_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> standard sequences&quot;</span>
            <span class="p">)</span>
            <span class="n">best_standard</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comparison_data</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">advantage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">best_score</span> <span class="o">-</span> <span class="n">best_standard</span>
            <span class="k">if</span> <span class="n">advantage</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Advantage over best standard: +</span><span class="si">{</span><span class="n">advantage</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Best sequence found:&quot;</span><span class="p">)</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">best_sequence</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="GADD">
<a class="viewcode-back" href="../../api/gadd.html#gadd.gadd.GADD">[docs]</a>
<span class="k">class</span> <span class="nc">GADD</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Genetic Algorithm for Dynamical Decoupling optimization.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="GADD.__init__">
<a class="viewcode-back" href="../../api/gadd.html#gadd.gadd.GADD.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">backend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Backend</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">utility_function</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UtilityFunction</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">coloring</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="n">ColorAssignment</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">SeedSequence</span><span class="p">,</span> <span class="n">BitGenerator</span><span class="p">,</span> <span class="n">Generator</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TrainingConfig</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the GADD class.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span> <span class="o">=</span> <span class="n">backend</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_utility_function</span> <span class="o">=</span> <span class="n">utility_function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seed</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rng</span> <span class="o">=</span> <span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_population</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span> <span class="ow">or</span> <span class="n">TrainingConfig</span><span class="p">()</span>

        <span class="c1"># Set up coloring</span>
        <span class="k">if</span> <span class="n">coloring</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">backend</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Default coloring from backend</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coloring</span> <span class="o">=</span> <span class="n">ColorAssignment</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coloring</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># Convert dict to ColorAssignment</span>
            <span class="n">color_to_qubits</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">qubit</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">coloring</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">color</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">color_to_qubits</span><span class="p">:</span>
                    <span class="n">color_to_qubits</span><span class="p">[</span><span class="n">color</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">color_to_qubits</span><span class="p">[</span><span class="n">color</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qubit</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coloring</span> <span class="o">=</span> <span class="n">ColorAssignment</span><span class="o">.</span><span class="n">from_manual_assignment</span><span class="p">(</span><span class="n">color_to_qubits</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coloring</span><span class="p">,</span> <span class="n">ColorAssignment</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coloring</span> <span class="o">=</span> <span class="n">coloring</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coloring</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Training state for resume capability</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_training_state</span> <span class="o">=</span> <span class="kc">None</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">seed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seed</span>

    <span class="nd">@seed</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">seed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seed</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rng</span> <span class="o">=</span> <span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">backend</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">utility_function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_utility_function</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">coloring</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coloring</span>

    <span class="nd">@coloring</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">coloring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coloring</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coloring</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># Convert dict to ColorAssignment</span>
            <span class="n">color_to_qubits</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">qubit</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">coloring</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">color</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">color_to_qubits</span><span class="p">:</span>
                    <span class="n">color_to_qubits</span><span class="p">[</span><span class="n">color</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">color_to_qubits</span><span class="p">[</span><span class="n">color</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qubit</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coloring</span> <span class="o">=</span> <span class="n">ColorAssignment</span><span class="o">.</span><span class="n">from_manual_assignment</span><span class="p">(</span><span class="n">color_to_qubits</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coloring</span><span class="p">,</span> <span class="n">ColorAssignment</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coloring</span> <span class="o">=</span> <span class="n">coloring</span>
        <span class="k">elif</span> <span class="n">coloring</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coloring</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Coloring must be a dictionary, ColorAssignment instance, or None&quot;</span>
            <span class="p">)</span>

<div class="viewcode-block" id="GADD.apply_strategy">
<a class="viewcode-back" href="../../api/gadd.html#gadd.gadd.GADD.apply_strategy">[docs]</a>
    <span class="k">def</span> <span class="nf">apply_strategy</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">strategy</span><span class="p">:</span> <span class="n">DDStrategy</span><span class="p">,</span>
        <span class="n">target_circuit</span><span class="p">:</span> <span class="n">QuantumCircuit</span><span class="p">,</span>
        <span class="n">backend</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Backend</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">staggered</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuantumCircuit</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply a DD strategy to a target circuit.</span>

<span class="sd">        This is a convenience method that handles the circuit padding</span>
<span class="sd">        with the appropriate coloring for the backend.</span>

<span class="sd">        Args:</span>
<span class="sd">            strategy: DD strategy to apply.</span>
<span class="sd">            target_circuit: Circuit to apply DD to.</span>
<span class="sd">            backend: Backend for coloring (uses self.backend if None).</span>
<span class="sd">            staggered: Whether to apply CR-aware staggering for crosstalk suppression.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Circuit with DD sequences applied.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Use provided backend or fall back to instance backend</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span>

        <span class="c1"># Get coloring for the circuit</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coloring</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">coloring_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coloring</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">backend</span><span class="p">:</span>
            <span class="n">color_assignment</span> <span class="o">=</span> <span class="n">ColorAssignment</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">)</span>
            <span class="n">coloring_dict</span> <span class="o">=</span> <span class="n">color_assignment</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Fallback: all qubits same color</span>
            <span class="n">coloring_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">target_circuit</span><span class="o">.</span><span class="n">num_qubits</span><span class="p">)}</span>

        <span class="c1"># Apply the DD strategy</span>
        <span class="k">return</span> <span class="n">_apply_dd_strategy</span><span class="p">(</span>
            <span class="n">target_circuit</span><span class="p">,</span>
            <span class="n">strategy</span><span class="p">,</span>
            <span class="n">coloring_dict</span><span class="p">,</span>
            <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span>
            <span class="n">staggered</span><span class="o">=</span><span class="n">staggered</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="GADD.train">
<a class="viewcode-back" href="../../api/gadd.html#gadd.gadd.GADD.train">[docs]</a>
    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sampler</span><span class="p">:</span> <span class="n">Sampler</span><span class="p">,</span>
        <span class="n">training_circuit</span><span class="p">:</span> <span class="n">QuantumCircuit</span><span class="p">,</span>
        <span class="n">utility_function</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="n">UtilityFunction</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_iterations</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">benchmark_strategies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">DDStrategy</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">evaluate_benchmarks_each_iteration</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">resume_from_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">TrainingState</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">save_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">DDStrategy</span><span class="p">,</span> <span class="n">TrainingResult</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Train DD sequences using genetic algorithm.</span>

<span class="sd">        Args:</span>
<span class="sd">            sampler: Qiskit Sampler for circuit execution.</span>
<span class="sd">            training_circuit: Circuit to train on.</span>
<span class="sd">            utility_function: Function to evaluate circuit performance.</span>
<span class="sd">                Can be a callable(circuit, result) -&gt; float or a :class:`.UtilityFunction` instance.</span>
<span class="sd">            mode: Population initialization mode (&#39;random&#39; or &#39;uniform&#39;).</span>
<span class="sd">            save_iterations: Whether to save iteration data.</span>
<span class="sd">            benchmark_strategies: DD strategies to compare against. Must be a list of</span>
<span class="sd">                :class:`.DDStrategy` objects.</span>
<span class="sd">            evaluate_benchmarks_each_iteration: If ``True``, evaluate benchmarks at each</span>
<span class="sd">                iteration. If ``False``, only evaluate at the end.</span>
<span class="sd">            resume_from_state: Previous training state to resume from.</span>
<span class="sd">            save_path: Path to save training checkpoints.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (best_strategy, training_result).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># Normalize utility function</span>
        <span class="k">if</span> <span class="n">utility_function</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Default to success probability for all-zero state</span>
            <span class="n">utility_function</span> <span class="o">=</span> <span class="n">SuccessProbability</span><span class="p">(</span><span class="s2">&quot;0&quot;</span> <span class="o">*</span> <span class="n">training_circuit</span><span class="o">.</span><span class="n">num_qubits</span><span class="p">)</span>

        <span class="c1"># If it&#39;s a UtilityFunction instance, extract the compute method</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">utility_function</span><span class="p">,</span> <span class="s2">&quot;compute&quot;</span><span class="p">):</span>
            <span class="n">utility_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">circuit</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">utility_function</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span>
                <span class="n">result</span><span class="o">.</span><span class="n">quasi_dists</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;quasi_dists&quot;</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">result</span><span class="o">.</span><span class="n">get_counts</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">utility_func</span> <span class="o">=</span> <span class="n">utility_function</span>

        <span class="c1"># Set mode from config if not provided</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">mode</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;random&quot;</span><span class="p">,</span> <span class="s2">&quot;uniform&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Mode must be one of &#39;random&#39; or &#39;uniform&#39;.&quot;</span><span class="p">)</span>

        <span class="c1"># Initialize or resume training state</span>
        <span class="k">if</span> <span class="n">resume_from_state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_training_state</span> <span class="o">=</span> <span class="n">resume_from_state</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resuming training from iteration </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_training_state</span><span class="o">.</span><span class="n">iteration</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Fresh training - initialize population</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_training_state</span> <span class="o">=</span> <span class="n">TrainingState</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_training_state</span><span class="o">.</span><span class="n">population</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_population</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_training_state</span><span class="o">.</span><span class="n">mutation_probability</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">mutation_probability</span>

        <span class="c1"># Prepare benchmark strategies</span>
        <span class="n">benchmark_strategy_map</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># name -&gt; DDStrategy</span>
        <span class="k">if</span> <span class="n">benchmark_strategies</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">benchmark</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">benchmark_strategies</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;custom_strategy_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">benchmark_strategy_map</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">benchmark</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">benchmark_history</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="n">evaluate_benchmarks_each_iteration</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># Training loop</span>
        <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_training_state</span><span class="o">.</span><span class="n">iteration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">n_iterations</span>
        <span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GA Iteration </span><span class="si">{</span><span class="n">iteration</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">n_iterations</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Evaluate current population</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_population</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_training_state</span><span class="o">.</span><span class="n">population</span><span class="p">,</span> <span class="n">sampler</span><span class="p">,</span> <span class="n">training_circuit</span><span class="p">,</span> <span class="n">utility_func</span>
            <span class="p">)</span>

            <span class="c1"># Evaluate benchmark strategies if provided</span>
            <span class="n">iteration_benchmark_scores</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">evaluate_benchmarks_each_iteration</span> <span class="ow">and</span> <span class="n">benchmark_strategy_map</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Evaluating benchmark strategies...&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">strategy</span><span class="p">,</span> <span class="n">staggered</span><span class="p">)</span> <span class="ow">in</span> <span class="n">benchmark_strategy_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">padded_circuit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_dd</span><span class="p">(</span>
                        <span class="n">strategy</span><span class="p">,</span> <span class="n">training_circuit</span><span class="p">,</span> <span class="n">staggered</span><span class="o">=</span><span class="n">staggered</span>
                    <span class="p">)</span>
                    <span class="n">job</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">padded_circuit</span><span class="p">,</span> <span class="n">shots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">shots</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

                    <span class="c1"># Extract result</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;quasi_dists&quot;</span><span class="p">):</span>
                        <span class="n">circuit_result</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span>
                            <span class="s2">&quot;Result&quot;</span><span class="p">,</span>
                            <span class="p">(),</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;quasi_dists&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">quasi_dists</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">(</span>
                                    <span class="n">result</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">)</span>
                                    <span class="k">else</span> <span class="p">{}</span>
                                <span class="p">),</span>
                            <span class="p">},</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">circuit_result</span> <span class="o">=</span> <span class="n">result</span>

                    <span class="n">score</span> <span class="o">=</span> <span class="n">utility_func</span><span class="p">(</span><span class="n">padded_circuit</span><span class="p">,</span> <span class="n">circuit_result</span><span class="p">)</span>
                    <span class="n">iteration_benchmark_scores</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>

                    <span class="c1"># Track history</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">benchmark_history</span><span class="p">:</span>
                        <span class="n">benchmark_history</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">benchmark_history</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Track best performance</span>
            <span class="n">best_score</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">best_sequence</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">scores</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_training_state</span><span class="o">.</span><span class="n">best_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_score</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_training_state</span><span class="o">.</span><span class="n">best_sequences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best_sequence</span><span class="p">)</span>

            <span class="c1"># Save iteration data</span>
            <span class="k">if</span> <span class="n">save_iterations</span><span class="p">:</span>
                <span class="n">iteration_info</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;iteration&quot;</span><span class="p">:</span> <span class="n">iteration</span><span class="p">,</span>
                    <span class="s2">&quot;best_score&quot;</span><span class="p">:</span> <span class="n">best_score</span><span class="p">,</span>
                    <span class="s2">&quot;mean_score&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">values</span><span class="p">())),</span>
                    <span class="s2">&quot;std_score&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">values</span><span class="p">())),</span>
                    <span class="s2">&quot;mutation_probability&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_training_state</span><span class="o">.</span><span class="n">mutation_probability</span><span class="p">,</span>
                    <span class="s2">&quot;population_diversity&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_diversity</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_training_state</span><span class="o">.</span><span class="n">population</span>
                    <span class="p">),</span>
                <span class="p">}</span>

                <span class="c1"># Only add benchmark scores if we&#39;re tracking them each iteration</span>
                <span class="k">if</span> <span class="n">evaluate_benchmarks_each_iteration</span> <span class="ow">and</span> <span class="n">iteration_benchmark_scores</span><span class="p">:</span>
                    <span class="n">iteration_info</span><span class="p">[</span><span class="s2">&quot;benchmark_scores&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iteration_benchmark_scores</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_training_state</span><span class="o">.</span><span class="n">iteration_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iteration_info</span><span class="p">)</span>

            <span class="c1"># Dynamic mutation adjustment</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">dynamic_mutation</span> <span class="ow">and</span> <span class="n">iteration</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_adjust_mutation_probability</span><span class="p">(</span><span class="n">iteration_info</span><span class="p">)</span>

            <span class="c1"># Generate next population (except for last iteration)</span>
            <span class="k">if</span> <span class="n">iteration</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">n_iterations</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Generate offspring from current population</span>
                <span class="n">new_population</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_offspring</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_training_state</span><span class="o">.</span><span class="n">population</span><span class="p">,</span> <span class="n">scores</span>
                <span class="p">)</span>

                <span class="c1"># Evaluate the combined population (parents + offspring)</span>
                <span class="n">all_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_population</span><span class="p">(</span>
                    <span class="n">new_population</span><span class="p">,</span> <span class="n">sampler</span><span class="p">,</span> <span class="n">training_circuit</span><span class="p">,</span> <span class="n">utility_func</span>
                <span class="p">)</span>

                <span class="c1"># Select top K for next generation</span>
                <span class="n">sorted_combined</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                    <span class="n">new_population</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">all_scores</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_training_state</span><span class="o">.</span><span class="n">population</span> <span class="o">=</span> <span class="n">sorted_combined</span><span class="p">[</span>
                    <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pop_size</span>
                <span class="p">]</span>

            <span class="c1"># Update iteration counter</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_training_state</span><span class="o">.</span><span class="n">iteration</span> <span class="o">=</span> <span class="n">iteration</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="c1"># Save checkpoint if path provided</span>
            <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_save_checkpoint</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Best score: </span><span class="si">{</span><span class="n">best_score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, Mean: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Get final best sequence</span>
        <span class="n">final_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evaluate_population</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_training_state</span><span class="o">.</span><span class="n">population</span><span class="p">,</span> <span class="n">sampler</span><span class="p">,</span> <span class="n">training_circuit</span><span class="p">,</span> <span class="n">utility_func</span>
        <span class="p">)</span>
        <span class="n">best_sequence</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">final_scores</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">final_scores</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
        <span class="n">best_score</span> <span class="o">=</span> <span class="n">final_scores</span><span class="p">[</span><span class="n">best_sequence</span><span class="p">]</span>

        <span class="c1"># Calculate training time</span>
        <span class="n">training_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

        <span class="c1"># Evaluate benchmarks at the end if not done during training</span>
        <span class="n">final_benchmark_scores</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">benchmark_strategy_map</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">evaluate_benchmarks_each_iteration</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Evaluating benchmark strategies...&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">strategy</span><span class="p">,</span> <span class="n">staggered</span><span class="p">)</span> <span class="ow">in</span> <span class="n">benchmark_strategy_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">padded_circuit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_strategy</span><span class="p">(</span>
                        <span class="n">strategy</span><span class="p">,</span> <span class="n">training_circuit</span><span class="p">,</span> <span class="n">staggered</span><span class="o">=</span><span class="n">staggered</span>
                    <span class="p">)</span>
                    <span class="n">job</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">padded_circuit</span><span class="p">,</span> <span class="n">shots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">shots</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;quasi_dists&quot;</span><span class="p">):</span>
                        <span class="n">circuit_result</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span>
                            <span class="s2">&quot;Result&quot;</span><span class="p">,</span>
                            <span class="p">(),</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;quasi_dists&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">quasi_dists</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">(</span>
                                    <span class="n">result</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">)</span>
                                    <span class="k">else</span> <span class="p">{}</span>
                                <span class="p">),</span>
                            <span class="p">},</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">circuit_result</span> <span class="o">=</span> <span class="n">result</span>

                    <span class="n">score</span> <span class="o">=</span> <span class="n">utility_func</span><span class="p">(</span><span class="n">padded_circuit</span><span class="p">,</span> <span class="n">circuit_result</span><span class="p">)</span>
                    <span class="n">final_benchmark_scores</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">score</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Get final scores from history</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">scores</span> <span class="ow">in</span> <span class="n">benchmark_history</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">scores</span><span class="p">:</span>
                        <span class="n">final_benchmark_scores</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">scores</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Create result</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">TrainingResult</span><span class="p">(</span>
            <span class="n">best_sequence</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_strategy_from_string</span><span class="p">(</span><span class="n">best_sequence</span><span class="p">),</span>
            <span class="n">best_score</span><span class="o">=</span><span class="n">best_score</span><span class="p">,</span>
            <span class="n">iteration_data</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_training_state</span><span class="o">.</span><span class="n">iteration_data</span><span class="p">,</span>
            <span class="n">benchmark_scores</span><span class="o">=</span><span class="n">final_benchmark_scores</span><span class="p">,</span>
            <span class="n">final_population</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_training_state</span><span class="o">.</span><span class="n">population</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
            <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
            <span class="n">training_time</span><span class="o">=</span><span class="n">training_time</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_strategy_from_string</span><span class="p">(</span><span class="n">best_sequence</span><span class="p">),</span> <span class="n">result</span></div>


    <span class="k">def</span> <span class="nf">_initialize_population</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;random&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize population of DD sequences.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;uniform&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_uniform_population</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_random_population</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_initialize_uniform_population</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize uniform population as described in the paper.&quot;&quot;&quot;</span>
        <span class="n">population</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">group_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">decoupling_group</span><span class="o">.</span><span class="n">size</span>

        <span class="c1"># Calculate repetitions per element</span>
        <span class="n">reps_per_element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pop_size</span> <span class="o">//</span> <span class="n">group_size</span>
        <span class="k">if</span> <span class="n">reps_per_element</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">reps_per_element</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Generate base patterns with cyclic shifts</span>
        <span class="n">base_patterns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">shift</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sequence_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pop_size</span><span class="p">)):</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sequence_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">element</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">shift</span><span class="p">)</span> <span class="o">%</span> <span class="n">group_size</span>
                <span class="n">pattern</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="n">base_patterns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>

        <span class="c1"># Generate variants for each base pattern</span>
        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">base_patterns</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">population</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pop_size</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">sequence</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># Calculate last element to make sequence multiply to identity</span>
            <span class="n">last_element</span> <span class="o">=</span> <span class="n">complete_sequence_to_identity</span><span class="p">(</span>
                <span class="n">sequence</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">decoupling_group</span>
            <span class="p">)</span>
            <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_element</span><span class="p">)</span>

            <span class="c1"># Create strategy for all colors</span>
            <span class="n">strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode_strategy</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
            <span class="n">population</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">strategy</span><span class="p">)</span>

        <span class="c1"># Fill remaining slots with random sequences</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">population</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pop_size</span><span class="p">:</span>
            <span class="n">sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_random_sequence</span><span class="p">()</span>
            <span class="n">strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode_strategy</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">strategy</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">population</span><span class="p">:</span>
                <span class="n">population</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">strategy</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">population</span>

    <span class="k">def</span> <span class="nf">_initialize_random_population</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize random population.&quot;&quot;&quot;</span>
        <span class="n">population</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">population</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pop_size</span><span class="p">:</span>
            <span class="n">sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_random_sequence</span><span class="p">()</span>
            <span class="n">strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_encode_strategy</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">strategy</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">population</span><span class="p">:</span>
                <span class="n">population</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">strategy</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">population</span>

    <span class="k">def</span> <span class="nf">_generate_random_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a random DD sequence that multiplies to identity.&quot;&quot;&quot;</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sequence_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rng</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">decoupling_group</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

        <span class="c1"># Calculate last element to ensure multiplication to identity</span>
        <span class="n">last_element</span> <span class="o">=</span> <span class="n">complete_sequence_to_identity</span><span class="p">(</span>
            <span class="n">sequence</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">decoupling_group</span>
        <span class="p">)</span>
        <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_element</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sequence</span>

    <span class="k">def</span> <span class="nf">_encode_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sequence</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Encode a sequence as a strategy string.&quot;&quot;&quot;</span>
        <span class="c1"># For multi-color strategies, repeat sequence for each color</span>
        <span class="n">strategy_parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">num_colors</span><span class="p">):</span>
            <span class="n">strategy_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sequence</span><span class="p">))</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">strategy_parts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_decode_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decode strategy string back to gate sequence.&quot;&quot;&quot;</span>
        <span class="c1"># Extract first color sequence (they should all be the same for now)</span>
        <span class="n">seq_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sequence_length</span>
        <span class="n">first_sequence</span> <span class="o">=</span> <span class="n">strategy</span><span class="p">[:</span><span class="n">seq_len</span><span class="p">]</span>

        <span class="n">gates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">first_sequence</span><span class="p">:</span>
            <span class="n">gates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">decoupling_group</span><span class="o">.</span><span class="n">element_name</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">char</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">gates</span>

    <span class="k">def</span> <span class="nf">_create_strategy_from_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DDStrategy</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create DDStrategy object from encoded string.&quot;&quot;&quot;</span>
        <span class="n">gates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decode_sequence</span><span class="p">(</span><span class="n">strategy</span><span class="p">)</span>
        <span class="n">dd_sequence</span> <span class="o">=</span> <span class="n">DDSequence</span><span class="p">(</span><span class="n">gates</span><span class="p">)</span>

        <span class="c1"># Create strategy with same sequence for all colors</span>
        <span class="n">sequences</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">num_colors</span><span class="p">):</span>
            <span class="n">sequences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dd_sequence</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">DDStrategy</span><span class="p">(</span><span class="n">sequences</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_evaluate_population</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">population</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">sampler</span><span class="p">:</span> <span class="n">Sampler</span><span class="p">,</span>
        <span class="n">circuit</span><span class="p">:</span> <span class="n">QuantumCircuit</span><span class="p">,</span>
        <span class="n">utility_function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate fitness of all sequences in population.&quot;&quot;&quot;</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Batch circuits for efficiency</span>
        <span class="n">circuits_to_run</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">strategy_map</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">strategy_str</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">population</span><span class="p">):</span>
            <span class="c1"># Create strategy object</span>
            <span class="n">dd_strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_strategy_from_string</span><span class="p">(</span><span class="n">strategy_str</span><span class="p">)</span>

            <span class="c1"># Apply DD to circuit</span>
            <span class="n">padded_circuit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_strategy</span><span class="p">(</span><span class="n">dd_strategy</span><span class="p">,</span> <span class="n">circuit</span><span class="p">)</span>
            <span class="n">circuits_to_run</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">padded_circuit</span><span class="p">)</span>
            <span class="n">strategy_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">strategy_str</span>

        <span class="c1"># Run all circuits in a single job for efficiency</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Evaluating </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">circuits_to_run</span><span class="p">)</span><span class="si">}</span><span class="s2"> circuits...&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">circuits_to_run</span><span class="p">,</span> <span class="n">shots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">shots</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

        <span class="c1"># Calculate utilities</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">strategy_str</span> <span class="ow">in</span> <span class="n">strategy_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Extract result for this circuit</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="s2">&quot;quasi_dists&quot;</span><span class="p">):</span>
                <span class="n">circuit_result</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span>
                    <span class="s2">&quot;Result&quot;</span><span class="p">,</span>
                    <span class="p">(),</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;quasi_dists&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">results</span><span class="o">.</span><span class="n">quasi_dists</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span>
                        <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">(</span>
                            <span class="n">results</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>
                        <span class="p">),</span>
                    <span class="p">},</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">circuit_result</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="c1"># Calculate utility</span>
            <span class="n">scores</span><span class="p">[</span><span class="n">strategy_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">utility_function</span><span class="p">(</span><span class="n">circuits_to_run</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">circuit_result</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;  Evaluated </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">population</span><span class="p">)</span><span class="si">}</span><span class="s2"> strategies. Best: </span><span class="si">{</span><span class="nb">max</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">scores</span>

    <span class="k">def</span> <span class="nf">_generate_offspring</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">scores</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate offspring population following the paper&#39;s GA approach.</span>

<span class="sd">        1. Keep original K parents</span>
<span class="sd">        2. Generate 2K offspring through reproduction</span>
<span class="sd">        3. Return combined 3K population for evaluation and selection</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">K</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">population</span><span class="p">)</span>

        <span class="c1"># Sort population and select parents</span>
        <span class="n">sorted_pop</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">population</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">scores</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">n_parents</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">parent_fraction</span> <span class="o">*</span> <span class="n">K</span><span class="p">))</span>
        <span class="n">parents</span> <span class="o">=</span> <span class="n">sorted_pop</span><span class="p">[:</span><span class="n">n_parents</span><span class="p">]</span>

        <span class="c1"># Generate 2K offspring</span>
        <span class="n">offspring</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">K</span><span class="p">):</span>
            <span class="c1"># Select two parents for reproduction</span>
            <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_parents</span><span class="p">(</span><span class="n">parents</span><span class="p">,</span> <span class="n">scores</span><span class="p">)</span>
            <span class="n">child</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_crossover</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>

            <span class="c1"># Apply mutation with probability</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rng</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_training_state</span><span class="o">.</span><span class="n">mutation_probability</span><span class="p">:</span>
                <span class="n">child</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mutate</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

            <span class="n">offspring</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

        <span class="c1"># Return combined population (K parents + 2K offspring = 3K total)</span>
        <span class="k">return</span> <span class="n">population</span> <span class="o">+</span> <span class="n">offspring</span>

    <span class="k">def</span> <span class="nf">_select_parents</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">parents</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">scores</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Select two parents using fitness-proportional selection.&quot;&quot;&quot;</span>
        <span class="c1"># Convert scores to probabilities</span>
        <span class="n">parent_scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">scores</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">]</span>
        <span class="n">min_score</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">parent_scores</span><span class="p">)</span>

        <span class="c1"># Shift scores to be positive and add small epsilon</span>
        <span class="n">adjusted_scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="o">-</span> <span class="n">min_score</span> <span class="o">+</span> <span class="mf">0.001</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">parent_scores</span><span class="p">]</span>
        <span class="n">total_score</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">adjusted_scores</span><span class="p">)</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="o">/</span> <span class="n">total_score</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">adjusted_scores</span><span class="p">]</span>

        <span class="c1"># Select two parents</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">parents</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">probabilities</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">parents</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">parents</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">_crossover</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent1</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">parent2</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform crossover between two strategy strings.&quot;&quot;&quot;</span>
        <span class="n">seq_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sequence_length</span>

        <span class="c1"># Work with first color sequence</span>
        <span class="n">seq1</span> <span class="o">=</span> <span class="n">parent1</span><span class="p">[:</span><span class="n">seq_len</span><span class="p">]</span>
        <span class="n">seq2</span> <span class="o">=</span> <span class="n">parent2</span><span class="p">[:</span><span class="n">seq_len</span><span class="p">]</span>

        <span class="c1"># Random crossover point</span>
        <span class="n">point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rng</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">)</span>

        <span class="c1"># Create child sequence</span>
        <span class="n">child_seq</span> <span class="o">=</span> <span class="n">seq1</span><span class="p">[:</span><span class="n">point</span><span class="p">]</span> <span class="o">+</span> <span class="n">seq2</span><span class="p">[</span><span class="n">point</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># Exclude last element</span>

        <span class="c1"># Calculate last element to maintain group constraint</span>
        <span class="n">child_indices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">child_seq</span><span class="p">]</span>
        <span class="n">last_element</span> <span class="o">=</span> <span class="n">complete_sequence_to_identity</span><span class="p">(</span>
            <span class="n">child_indices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">decoupling_group</span>
        <span class="p">)</span>
        <span class="n">child_seq</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">last_element</span><span class="p">)</span>

        <span class="c1"># Replicate for all colors</span>
        <span class="k">return</span> <span class="n">child_seq</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">num_colors</span>

    <span class="k">def</span> <span class="nf">_mutate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Mutate a strategy string.&quot;&quot;&quot;</span>
        <span class="n">seq_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">sequence_length</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">strategy</span><span class="p">[:</span><span class="n">seq_len</span><span class="p">])</span>

        <span class="c1"># Mutate random position (except last)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rng</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">seq</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rng</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">decoupling_group</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>

            <span class="c1"># Recalculate last element</span>
            <span class="n">seq_indices</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">seq</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">last_element</span> <span class="o">=</span> <span class="n">complete_sequence_to_identity</span><span class="p">(</span>
                <span class="n">seq_indices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">decoupling_group</span>
            <span class="p">)</span>
            <span class="n">seq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">last_element</span><span class="p">)</span>

        <span class="c1"># Replicate for all colors</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">num_colors</span>

    <span class="k">def</span> <span class="nf">_adjust_mutation_probability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dynamically adjust mutation probability based on population diversity.&quot;&quot;&quot;</span>
        <span class="n">diversity</span> <span class="o">=</span> <span class="n">iteration_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;population_diversity&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">diversity</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>  <span class="c1"># Low diversity - increase mutation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_training_state</span><span class="o">.</span><span class="n">mutation_probability</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                <span class="mf">0.9</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_training_state</span><span class="o">.</span><span class="n">mutation_probability</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">mutation_decay</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">diversity</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">:</span>  <span class="c1"># High diversity - decrease mutation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_training_state</span><span class="o">.</span><span class="n">mutation_probability</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="mf">0.1</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_training_state</span><span class="o">.</span><span class="n">mutation_probability</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">mutation_decay</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_calculate_diversity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">population</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate population diversity as fraction of unique individuals.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">population</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">population</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_evaluate_standard_sequences</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sequences</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">sampler</span><span class="p">:</span> <span class="n">Sampler</span><span class="p">,</span>
        <span class="n">circuit</span><span class="p">:</span> <span class="n">QuantumCircuit</span><span class="p">,</span>
        <span class="n">utility_function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate standard DD sequences for comparison.&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">std_sequences</span> <span class="o">=</span> <span class="n">StandardSequences</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">seq_name</span> <span class="ow">in</span> <span class="n">sequences</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Evaluating standard sequence: </span><span class="si">{</span><span class="n">seq_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sequence</span> <span class="o">=</span> <span class="n">std_sequences</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">seq_name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                <span class="n">strategy</span> <span class="o">=</span> <span class="n">DDStrategy</span><span class="o">.</span><span class="n">from_single_sequence</span><span class="p">(</span>
                    <span class="n">sequence</span><span class="p">,</span> <span class="n">n_colors</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">num_colors</span>
                <span class="p">)</span>

                <span class="c1"># Check if this should be staggered</span>
                <span class="n">staggered</span> <span class="o">=</span> <span class="n">std_sequences</span><span class="o">.</span><span class="n">is_staggered</span><span class="p">(</span><span class="n">seq_name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

                <span class="n">padded_circuit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_strategy</span><span class="p">(</span>
                    <span class="n">strategy</span><span class="p">,</span> <span class="n">circuit</span><span class="p">,</span> <span class="n">staggered</span><span class="o">=</span><span class="n">staggered</span>
                <span class="p">)</span>

                <span class="n">job</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">padded_circuit</span><span class="p">,</span> <span class="n">shots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">shots</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                <span class="n">results</span><span class="p">[</span><span class="n">seq_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">utility_function</span><span class="p">(</span><span class="n">padded_circuit</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not evaluate </span><span class="si">{</span><span class="n">seq_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="n">seq_name</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">_save_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save training checkpoint.&quot;&quot;&quot;</span>
        <span class="c1"># Create directory if it doesn&#39;t exist</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">checkpoint</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_training_state</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
            <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
        <span class="p">}</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">save_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;checkpoint_iter_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_training_state</span><span class="o">.</span><span class="n">iteration</span><span class="si">}</span><span class="s2">.json&quot;</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checkpoint saved to </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="GADD.load_training_state">
<a class="viewcode-back" href="../../api/gadd.html#gadd.gadd.GADD.load_training_state">[docs]</a>
    <span class="k">def</span> <span class="nf">load_training_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">checkpoint_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TrainingState</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load training state from checkpoint file.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">checkpoint_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">TrainingState</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">])</span></div>


<div class="viewcode-block" id="GADD.plot_training_progress">
<a class="viewcode-back" href="../../api/gadd.html#gadd.gadd.GADD.plot_training_progress">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_training_progress</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">TrainingResult</span><span class="p">,</span> <span class="n">save_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot training progression and comparison data.&quot;&quot;&quot;</span>
        <span class="c1"># Determine number of subplots needed</span>
        <span class="n">n_plots</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">comparison_data</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">benchmark_history</span><span class="p">:</span>
            <span class="n">n_plots</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_plots</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="n">n_plots</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">n_plots</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span>

        <span class="c1"># Plot training progression</span>
        <span class="n">ax1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">iterations</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;iteration&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">iteration_data</span><span class="p">]</span>
        <span class="n">best_scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;best_score&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">iteration_data</span><span class="p">]</span>
        <span class="n">mean_scores</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;mean_score&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">iteration_data</span><span class="p">]</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">iterations</span><span class="p">,</span> <span class="n">best_scores</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Best Score&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">iterations</span><span class="p">,</span> <span class="n">mean_scores</span><span class="p">,</span> <span class="s2">&quot;-s&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Mean Score&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

        <span class="c1"># Add benchmark lines if available</span>
        <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">benchmark_history</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">scores</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">benchmark_history</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">iterations</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)],</span>
                    <span class="n">scores</span><span class="p">,</span>
                    <span class="s2">&quot;--&quot;</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (benchmark)&quot;</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
            <span class="n">iterations</span><span class="p">,</span>
            <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;mean_score&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;std_score&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">iteration_data</span><span class="p">],</span>
            <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;mean_score&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;std_score&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">iteration_data</span><span class="p">],</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;±1 STD&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Utility Score&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Training Progression&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="c1"># Plot comparison data</span>
        <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">comparison_data</span> <span class="ow">and</span> <span class="n">n_plots</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">comparison_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">comparison_data</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

            <span class="c1"># Add GADD result for comparison</span>
            <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;GADD&quot;</span><span class="p">)</span>
            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">best_score</span><span class="p">)</span>

            <span class="c1"># Create bar plot</span>
            <span class="n">bars</span> <span class="o">=</span> <span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>

            <span class="c1"># Highlight GADD bar</span>
            <span class="n">bars</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s2">&quot;green&quot;</span><span class="p">)</span>
            <span class="n">bars</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mf">0.8</span><span class="p">)</span>

            <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;DD Sequence&quot;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Utility Score&quot;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Sequence Comparison&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_majorticklabels</span><span class="p">(),</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>

            <span class="c1"># Add value labels on bars</span>
            <span class="k">for</span> <span class="n">bar</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bars</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                    <span class="n">bar</span><span class="o">.</span><span class="n">get_x</span><span class="p">()</span> <span class="o">+</span> <span class="n">bar</span><span class="o">.</span><span class="n">get_width</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="n">bar</span><span class="o">.</span><span class="n">get_height</span><span class="p">()</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
                    <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="c1"># Plot benchmark history separately if we have 3 plots</span>
        <span class="k">if</span> <span class="n">results</span><span class="o">.</span><span class="n">benchmark_history</span> <span class="ow">and</span> <span class="n">n_plots</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">ax3</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">scores</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">benchmark_history</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">iterations</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores</span><span class="p">)],</span> <span class="n">scores</span><span class="p">,</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

            <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Iteration&quot;</span><span class="p">)</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Utility Score&quot;</span><span class="p">)</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Benchmark Performance&quot;</span><span class="p">)</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">ax3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plot saved to </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="GADD.evaluate">
<a class="viewcode-back" href="../../api/gadd.html#gadd.gadd.GADD.evaluate">[docs]</a>
    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">strategy</span><span class="p">:</span> <span class="n">DDStrategy</span><span class="p">,</span>
        <span class="n">target_circuit</span><span class="p">:</span> <span class="n">QuantumCircuit</span><span class="p">,</span>
        <span class="n">sampler</span><span class="p">:</span> <span class="n">Sampler</span><span class="p">,</span>
        <span class="n">utility_function</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">QuantumCircuit</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">staggered</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run a specific DD strategy on a target circuit and evaluate its utility.</span>

<span class="sd">        Args:</span>
<span class="sd">            strategy: DD strategy to apply.</span>
<span class="sd">            target_circuit: Target quantum circuit.</span>
<span class="sd">            sampler: Qiskit sampler for execution.</span>
<span class="sd">            utility_function: Optional utility function to evaluate performance.</span>
<span class="sd">            staggered: Whether to apply CR-aware staggering.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with execution results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Apply DD strategy to circuit</span>
        <span class="n">padded_circuit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_strategy</span><span class="p">(</span>
            <span class="n">strategy</span><span class="p">,</span> <span class="n">target_circuit</span><span class="p">,</span> <span class="n">staggered</span><span class="o">=</span><span class="n">staggered</span>
        <span class="p">)</span>

        <span class="c1"># Execute circuit</span>
        <span class="n">job</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">padded_circuit</span><span class="p">,</span> <span class="n">shots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">shots</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

        <span class="c1"># Get counts (handling different result formats)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;quasi_dists&quot;</span><span class="p">):</span>
            <span class="n">counts</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">quasi_dists</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s2">&quot;get_counts&quot;</span><span class="p">):</span>
            <span class="n">counts</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get_counts</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to extract counts from result&quot;</span><span class="p">)</span>

        <span class="c1"># Calculate utility if function provided</span>
        <span class="n">utility_value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">utility_function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">utility_value</span> <span class="o">=</span> <span class="n">utility_function</span><span class="p">(</span><span class="n">padded_circuit</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;counts&quot;</span><span class="p">:</span> <span class="n">counts</span><span class="p">,</span>
            <span class="s2">&quot;utility&quot;</span><span class="p">:</span> <span class="n">utility_value</span><span class="p">,</span>
            <span class="s2">&quot;padded_circuit&quot;</span><span class="p">:</span> <span class="n">padded_circuit</span><span class="p">,</span>
            <span class="s2">&quot;staggered&quot;</span><span class="p">:</span> <span class="n">staggered</span><span class="p">,</span>
            <span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span>  <span class="c1"># Include full result for flexibility</span>
        <span class="p">}</span></div>
</div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, GADD Contributors
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=01f34227"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    </body>
</html>